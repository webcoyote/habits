#!/usr/bin/env bash
# Common simulator lookup logic

# Only enable strict mode if script is executed directly (not sourced)
if [[ "${BASH_SOURCE[0]}" == "$0" ]]; then
    set -Eeuo pipefail
    trap 'echo "${BASH_SOURCE[0]}: line $LINENO: $BASH_COMMAND: exitcode $?"' ERR
fi

# Only lookup if SIMULATOR_ID is not already set
if [[ -z "${SIMULATOR_ID:-}" ]]; then
    # Default to latest iPhone on latest OS (overrideable via SIMULATOR_DEVICE env var)
    SIMULATOR_DEVICE="${SIMULATOR_DEVICE:-iPhone 17 Pro}"

    # Look up simulator UDID by device name
    SIMULATOR_ID=$(xcrun simctl list devices | grep "$SIMULATOR_DEVICE" | grep -o -E '[0-9A-F]{8}-[0-9A-F]{4}-[0-9A-F]{4}-[0-9A-F]{4}-[0-9A-F]{12}' | head -1 || true)

    if [[ -z "$SIMULATOR_ID" ]]; then
        # Simulator not found - create it automatically
        # echo "⚠️  Simulator '$SIMULATOR_DEVICE' not found, creating it..." >&2

        # Get latest iOS runtime
        LATEST_IOS_RUNTIME=$(xcrun simctl list runtimes | grep iOS | tail -1 | grep -o 'com\.apple\.CoreSimulator\.SimRuntime\.iOS-[0-9-]*')

        if [[ -z "$LATEST_IOS_RUNTIME" ]]; then
            echo "❌ No iOS runtime found" >&2
            exit 1
        fi

        # Convert device name to device type identifier
        # "iPhone 17 Pro" -> "iPhone-17-Pro"
        # "iPhone SE (3rd generation)" -> "iPhone-SE-3rd-generation"
        DEVICE_TYPE=$(echo "$SIMULATOR_DEVICE" | sed 's/ (/-/g' | sed 's/)//g' | sed 's/ /-/g')

        # Create the simulator
        echo "➕ Creating $SIMULATOR_DEVICE..." >&2
        xcrun simctl create "$SIMULATOR_DEVICE" "com.apple.CoreSimulator.SimDeviceType.$DEVICE_TYPE" "$LATEST_IOS_RUNTIME" >/dev/null

        # Look up the newly created simulator
        SIMULATOR_ID=$(xcrun simctl list devices | grep "$SIMULATOR_DEVICE" | grep -o -E '[0-9A-F]{8}-[0-9A-F]{4}-[0-9A-F]{4}-[0-9A-F]{4}-[0-9A-F]{12}' | head -1 || true)

        if [[ -z "$SIMULATOR_ID" ]]; then
            echo "❌ Failed to create simulator '$SIMULATOR_DEVICE'" >&2
            exit 1
        fi
    fi
fi

if [[ "${BASH_SOURCE[0]}" == "$0" ]]; then
    echo "$SIMULATOR_ID"
fi
